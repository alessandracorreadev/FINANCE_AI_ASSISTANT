<script>
  (function() {
    function scrollChatToBottom() {
      const chatContainer = document.getElementById('chat-messages');
      if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    }

    function clearMessageInput() {
      const form = document.getElementById('message-form');
      if (form) {
        form.reset();
      }
    }

    function setupChat() {
      scrollChatToBottom();
      clearMessageInput();

      const chatMessages = document.getElementById('chat-messages');
      if (chatMessages) {
        const observer = new MutationObserver(scrollChatToBottom);
        observer.observe(chatMessages, { childList: true, subtree: true });
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupChat);
    } else {
      setupChat();
    }

    document.addEventListener('turbo:load', setupChat);
    document.addEventListener('turbo:frame-load', setupChat);
    document.addEventListener('turbo:render', clearMessageInput);
  })();
</script>

<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Chat - <%= @month.month %> <%= @month.year %></h5>
          <%= link_to "Back to month", month_path(@month), class: "btn btn-outline-secondary btn-sm" %>
        </div>

        <div class="card-body" style="height: 400px; overflow-y: auto;" id="chat-messages">
          <% if @messages.empty? %>
            <p class="text-muted text-center">No messages yet. Start the conversation!</p>
          <% else %>
            <% @messages.each do |message| %>
              <div class="mb-3 <%= message.role == 'user' ? 'text-end' : '' %>">
                <div class="d-inline-block p-2 rounded <%= message.role == 'user' ? 'bg-primary text-white' : 'bg-light' %>" style="max-width: 80%;">
                  <small class="d-block fw-bold"><%= message.role == 'user' ? 'You' : 'Assistant' %></small>
                  <%= simple_format(message.content) %>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>

        <div class="card-footer">
          <%= form_with url: month_chat_messages_path(@month), method: :post, local: true, class: "d-flex gap-2", html: { autocomplete: "off" }, id: "message-form" do |f| %>
            <input type="text" name="message[content]" class="form-control" placeholder="Type your question..." required autofocus autocomplete="off">
            <button type="submit" class="btn btn-primary">Send</button>
          <% end %>
        </div>
      </div>

      <div class="mt-3">
        <div class="card">
          <div class="card-header">
            <small class="text-muted">Month context</small>
          </div>
          <div class="card-body">
            <p class="mb-0"><%= @month.overview.presence || "No overview provided for this month." %></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
