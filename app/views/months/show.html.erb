<!-- app/views/months/show.html.erb -->

<%
  data = @month.financial_data || {}
  income = data["income"].to_f
  expenses = data["expenses"].to_f
  balance = income - expenses
  categories = data["categories"] || {}
  savings_rate = income > 0 ? ((balance / income) * 100).round(1) : 0
%>

<div class="container-fluid py-4">
  <div class="row">

    <!-- Left column - Text and actions -->
    <div class="col-lg-6 px-5">
      <p class="text-success text-uppercase small fw-semibold mb-4">Finance AI Assistant</p>
      <h1 class="display-4 fw-bold mb-3">
        <%= @month.month %> <%= @month.year %> <span class="text-success">overview</span>
      </h1>
      <p class="text-muted mb-5">
        Review your financial data for this month. You can edit the details or chat with the
        AI assistant to get personalized advice based on your finances.
      </p>
      <div class="d-flex gap-2 mb-4">
        <%= link_to "Back to months", months_path, class: "btn btn-outline-secondary btn-lg" %>
        <%= link_to "Edit", edit_month_path(@month), class: "btn btn-outline-primary btn-lg" %>
        <%= link_to "Delete", month_path(@month), method: :delete, data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this month?" }, class: "btn btn-outline-danger btn-lg" %>
      </div>

      <% if income > 0 || expenses > 0 %>
        <!-- Financial Summary Cards -->
        <div class="row g-3 mb-4">
          <div class="col-4">
            <div class="card shadow-sm h-100 border-0">
              <div class="card-body text-center py-3">
                <div class="mb-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="text-success" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/>
                  </svg>
                </div>
                <p class="text-muted small text-uppercase mb-1">Income</p>
                <h4 class="mb-0 text-success">$<%= number_with_delimiter(income.round(2)) %></h4>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div class="card shadow-sm h-100 border-0">
              <div class="card-body text-center py-3">
                <div class="mb-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="text-danger" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1z"/>
                  </svg>
                </div>
                <p class="text-muted small text-uppercase mb-1">Expenses</p>
                <h4 class="mb-0 text-danger">$<%= number_with_delimiter(expenses.round(2)) %></h4>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div class="card shadow-sm h-100 border-0">
              <div class="card-body text-center py-3">
                <div class="mb-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="<%= balance >= 0 ? 'text-primary' : 'text-warning' %>" viewBox="0 0 16 16">
                    <path d="M4 10.781c.148 1.667 1.513 2.85 3.591 3.003V15h1.043v-1.216c2.27-.179 3.678-1.438 3.678-3.3 0-1.59-.947-2.51-2.956-3.028l-.722-.187V3.467c1.122.11 1.879.714 2.07 1.616h1.47c-.166-1.6-1.54-2.748-3.54-2.875V1H7.591v1.233c-1.939.23-3.27 1.472-3.27 3.156 0 1.454.966 2.483 2.661 2.917l.61.162v4.031c-1.149-.17-1.94-.8-2.131-1.718H4zm3.391-3.836c-1.043-.263-1.6-.825-1.6-1.616 0-.944.704-1.641 1.8-1.828v3.495l-.2-.05zm1.591 1.872c1.287.323 1.852.859 1.852 1.769 0 1.097-.826 1.828-2.2 1.939V8.73l.348.086z"/>
                  </svg>
                </div>
                <p class="text-muted small text-uppercase mb-1">Balance</p>
                <h4 class="mb-0 <%= balance >= 0 ? 'text-primary' : 'text-warning' %>">$<%= number_with_delimiter(balance.round(2)) %></h4>
              </div>
            </div>
          </div>
        </div>

        <!-- Savings Rate -->
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted small text-uppercase">Savings Rate</span>
              <span class="fw-bold <%= savings_rate >= 20 ? 'text-success' : savings_rate >= 10 ? 'text-warning' : 'text-danger' %>"><%= savings_rate %>%</span>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar <%= savings_rate >= 20 ? 'bg-success' : savings_rate >= 10 ? 'bg-warning' : 'bg-danger' %>" 
                   role="progressbar" 
                   style="width: <%= [savings_rate, 100].min %>%"></div>
            </div>
          </div>
        </div>

        <% if categories.any? %>
          <!-- Expense Categories -->
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
              <h6 class="text-muted text-uppercase small mb-3">Expense Breakdown</h6>
              <% categories.each do |category, amount| %>
                <% percentage = expenses > 0 ? ((amount.to_f / expenses) * 100).round(1) : 0 %>
                <div class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="text-capitalize"><%= category %></span>
                    <span class="text-muted">$<%= number_with_delimiter(amount.to_f.round(2)) %> (<%= percentage %>%)</span>
                  </div>
                  <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-danger" role="progressbar" style="width: <%= percentage %>%"></div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>

    <!-- Right column - Details -->
    <div class="col-lg-6 d-flex justify-content-center align-items-start pt-5">
      <div class="card shadow-sm" style="width: 100%; max-width: 500px;">
        <div class="card-body p-4">
          <h4 class="card-title mb-4"><%= @month.month %> <%= @month.year %></h4>

          <div class="mb-4">
            <h6 class="text-muted text-uppercase small">Overview</h6>
            <p class="fs-6"><%= @month.overview.present? ? @month.overview : "No overview provided." %></p>
          </div>

          <% if @month.financial_data.present? && (income > 0 || expenses > 0) %>
            <div class="mb-4">
              <h6 class="text-muted text-uppercase small">Financial Summary</h6>
              <div class="d-flex justify-content-between py-2 border-bottom">
                <span class="text-muted">Income</span>
                <span class="text-success fw-bold">$<%= number_with_delimiter(income.round(2)) %></span>
              </div>
              <div class="d-flex justify-content-between py-2 border-bottom">
                <span class="text-muted">Expenses</span>
                <span class="text-danger fw-bold">$<%= number_with_delimiter(expenses.round(2)) %></span>
              </div>
              <div class="d-flex justify-content-between py-2 border-bottom">
                <span class="text-muted">Balance</span>
                <span class="<%= balance >= 0 ? 'text-success' : 'text-danger' %> fw-bold">$<%= number_with_delimiter(balance.round(2)) %></span>
              </div>
              <div class="d-flex justify-content-between py-2">
                <span class="text-muted">Daily Average</span>
                <span class="fw-bold">$<%= number_with_delimiter((expenses / 30.0).round(2)) %>/day</span>
              </div>
            </div>
          <% end %>

          <hr>

          <div class="d-grid">
            <%= link_to "Chat with AI Assistant", month_chat_path(@month), class: "btn btn-success btn-lg" %>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
